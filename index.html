<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cafe Mock ‚Äî Stove Orders & Cooking</title>
<style>
  :root{
    --cols: 20;
    --stage-maxw: 1280px;
    --stage-vw: 95vw;
    --bg-dark: #0f172a;
    --tile: 64px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg-dark);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#fff}

  #stage{
    width:min(var(--stage-maxw),var(--stage-vw));
    aspect-ratio:16/9;
    margin:24px auto 96px;
    position:relative;border-radius:18px;overflow:hidden;
    box-shadow:0 20px 60px rgba(0,0,0,.35)
  }
  #scene{position:absolute;inset:0}

  /* Lantai pixel */
  .wood{
    background-color:#d7b07a; image-rendering:pixelated;
    background-image:
      repeating-linear-gradient(0deg,#e9c98e 0px,#e9c98e 12px,#d7b07a 12px,#d7b07a 28px),
      repeating-linear-gradient(90deg,#d7b07a 0px,#d7b07a 56px,#cfa86f 56px,#cfa86f 112px);
    background-size:auto,auto;
  }

  /* Dinding (collider) */
  .wall{
    position:absolute;left:0;right:0;top:0;height:calc(var(--tile)*2.25);
    image-rendering:pixelated;
    background:
      repeating-linear-gradient(90deg,#efcfa1 0px,#efcfa1 24px,#e5c492 24px,#e5c492 48px),
      repeating-linear-gradient(0deg,#f3d7ac 0px,#f3d7ac 22px,#eacb9e 22px,#eacb9e 44px);
    border-bottom:4px solid #8b5e34; box-shadow:inset 0 -6px 0 #c08f58; z-index:1;
  }

  .coinbar{position:absolute;right:16px;top:16px;z-index:50;display:flex;gap:8px;align-items:center;background:#0b1220;color:#fff;padding:8px 12px;border-radius:999px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .dock{position:absolute;left:0;right:0;bottom:16px;z-index:50;display:flex;justify-content:center;gap:24px}
  .dock .btn{width:64px;height:64px;border-radius:999px;background:rgba(0,0,0,.25);color:#fff;border:none;font-size:24px;display:grid;place-items:center;backdrop-filter:blur(2px)}
  .dock label{display:block;text-align:center;margin-top:6px;font-size:12px;color:#fff;opacity:.8}

  .sprite{position:absolute;image-rendering:pixelated;user-select:none}
  .label{position:absolute;background-color:rgba(255,255,255,.85);color:#111;border:1px solid rgba(0,0,0,.15);border-radius:6px;padding:2px 6px;font-weight:800;letter-spacing:2px;font-size:10px;user-select:none}
  .z1{z-index:1}.z2{z-index:2}.z3{z-index:3}.z5{z-index:5}

  /* Panel pesanan */
  .orders{position:absolute;z-index:60;min-width:240px;max-width:300px;background:#0b1220; color:#fff; border:1px solid #223; border-radius:12px; padding:10px; box-shadow:0 16px 40px rgba(0,0,0,.5)}
  .orders h4{margin:2px 0 8px;font-size:14px;letter-spacing:.4px}
  .orders .list{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .orders button{all:unset;display:flex;align-items:center;justify-content:space-between;gap:10px;background:#1b2542;padding:8px 10px;border-radius:8px;cursor:pointer}
  .orders button:hover{background:#25335f}
  .orders .row{display:flex;align-items:center;gap:10px}
  .orders img.icon{width:28px;height:28px;image-rendering:pixelated}
  .orders .close{position:absolute;right:8px;top:6px;cursor:pointer;opacity:.8}
  .muted{opacity:.7;font-size:12px}

  /* Progress bar di atas stove */
  .cookbar{position:absolute;height:6px;background:#2dd4bf;border-radius:6px;left:0;right:0;bottom:-8px;transform-origin:left top}
  .cookwrap{position:absolute;left:0;right:0;bottom:0;height:0}
</style>
</head>
<body>

<script>
  /* ===== ASSETS ===== */
  window.ASSETS = {
    sheetJamur: "assets/Cute Shroom 4_result.webp",
    table:        "assets/table_top_result.webp",
    tableLongV:   "assets/table_long_vertical_result.webp",
    tableLongH:   "assets/table_long_horizontal_result.webp",
    chair:        "assets/chair_front_result.webp",
    stove:        "assets/stove_front_result.webp",
    trash:        "assets/trash_bin.png",

    /* Ikon menu PNG terpisah */
    menu: {
      nasi_kari:  "assets/nasi_kari.png",
      mie_goreng: "assets/mie_goreng.png",
      steak:      "assets/steak.png",
      sup_jagung: "assets/sup_jagung.png"
    }
  };
</script>

<div id="stage" class="wood">
  <div id="scene">
    <div class="wall"></div>
  </div>

  <div class="coinbar"><span>ü™ô</span><strong id="coin">9999</strong></div>
  <div class="dock">
    <div style="text-align:center"><button class="btn">üçÑ</button><label>Table</label></div>
    <div style="text-align:center"><button class="btn">üê±</button><label>Hire Worker</label></div>
    <div style="text-align:center"><button class="btn">üç≤</button><label>Add Menu</label></div>
    <div style="text-align:center"><button class="btn">‚öôÔ∏è</button><label>Settings</label></div>
  </div>
</div>

<script>
/* ===== Grid & helpers (tetap) ===== */
const COLS = 20;
const stage = document.getElementById('stage');
const scene = document.getElementById('scene');
const AS = window.ASSETS;

const items=[]; let colliders=[];
const T=()=>stage.clientWidth/COLS;

const addLabel=(txt,c,r)=>{const e=document.createElement('div');e.className='label';e.textContent=txt;scene.appendChild(e);items.push({el:e,col:c,row:r,w:0,h:0,z:9,isLabel:true});return e;}
function addSprite({src,col,row,w=1,h=1,z=2, cursor=null}){const el=new Image();el.className=`sprite z${z}`;el.src=src; if(cursor) el.style.cursor=cursor; scene.appendChild(el); const r={el,col,row,w,h,z,isLabel:false,isPlayer:false,isSheet:false};items.push(r);return r;}

const SHEET={cols:5,rows:5,frames:4,fps:10,rowDown:1,rowLeft:1,rowRight:2,rowUp:2};
function addSheetEntity({src,col,row,w=1,h=1,z=5}){
  const el=document.createElement('div'); el.className=`sprite z${z}`;
  el.style.backgroundImage=`url("${src}")`; el.style.backgroundRepeat='no-repeat'; el.style.imageRendering='pixelated';
  scene.appendChild(el);
  const rec={el,col,row,w,h,z,isLabel:false,isPlayer:true,isSheet:true,sheet:SHEET,dir:'down',frame:0};
  items.push(rec); return rec;
}
function applyBGSize(ent){
  const tile=T(); ent.el.style.width=(ent.w*tile)+'px'; ent.el.style.height=(ent.h*tile)+'px';
  ent.el.style.backgroundSize=`${ent.sheet.cols*100}% ${ent.sheet.rows*100}%`;
}
function setFrame(ent,frame,dirRow){
  const xPct=(frame/(ent.sheet.cols-1))*100;
  const yPct=(dirRow/(ent.sheet.rows-1))*100;
  ent.el.style.backgroundPosition = `${xPct}% ${yPct}%`;
}

function layout(){
  const tile=T(); document.documentElement.style.setProperty('--tile',tile+'px');
  for(const it of items){
    const x=(it.col-1)*tile, y=(it.row-1)*tile;
    if(it.isLabel){ it.el.style.left=(x-10)+'px'; it.el.style.top=(y-20)+'px'; continue; }
    it.el.style.left=x+'px'; it.el.style.top=y+'px';
    it.el.style.width=(it.w*tile)+'px'; it.el.style.height=(it.h*tile)+'px'; it.el.style.zIndex=it.z;
    if(it.isSheet) applyBGSize(it);
  }
  rebuildColliders();
}
const wallEl=document.querySelector('.wall');
function rebuildColliders(){
  colliders = items.filter(it=>!it.isLabel && !it.isPlayer);
  if(wallEl) colliders.push({el:wallEl});
}
const rect=r=>({x:r.el.offsetLeft,y:r.el.offsetTop,w:r.el.clientWidth,h:r.el.clientHeight});

/* Kursi di sekitar meja */
function addChairsAround(t,opt){
  const c=t.col, r=t.row, w=t.w||2, h=t.h||1;
  if(opt?.top)    for(let i=0;i<w;i++) addSprite({src:AS.chair,col:c+i,row:r-1});
  if(opt?.bottom) for(let i=0;i<w;i++) addSprite({src:AS.chair,col:c+i,row:r+1});
  if(opt?.left)   for(let i=0;i<h;i++) addSprite({src:AS.chair,col:c-1,row:r+i});
  if(opt?.right)  for(let i=0;i<h;i++) addSprite({src:AS.chair,col:c+w,row:r+i});
}

/* ===== Tata letak (tetap) ===== */
const tL2 = addSprite({src:AS.table,col:4,row:6,w:2,h:1}); addChairsAround(tL2,{top:true,bottom:true});
const tL3 = addSprite({src:AS.table,col:4,row:9,w:2,h:1}); addChairsAround(tL3,{top:true,bottom:true});
const tR2 = addSprite({src:AS.table,col:9,row:6,w:2,h:1}); addChairsAround(tR2,{top:true,bottom:true});
const tR3 = addSprite({src:AS.table,col:9,row:9,w:2,h:1}); addChairsAround(tR3,{top:true,bottom:true});

addSprite({src:AS.tableLongV,col:15,row:3,w:1,h:3});
const stove1 = addSprite({src:AS.stove,col:16,row:3,w:1,h:1,cursor:'pointer'});
const stove2 = addSprite({src:AS.stove,col:17,row:3,w:1,h:1,cursor:'pointer'});
const counter = addSprite({src:AS.tableLongH,col:17,row:7,w:4,h:1}); // meja saji
addSprite({src:AS.trash,col:20,row:8,w:1,h:1});

/* ===== Player & Waiter (jamur) ===== */
const player = addSheetEntity({src:AS.sheetJamur,col:12,row:6,w:1,h:1,z:5});
const waiter = addSheetEntity({src:AS.sheetJamur,col:13,row:6,w:1,h:1,z:5});

/* ===== Movement & collision helpers ===== */
function willCollide(nx,ny,pw,ph){
  for(const c of colliders){
    const r=rect(c);
    const overlap=!(nx+pw<=r.x||nx>=r.x+r.w||ny+ph<=r.y||ny>=r.y+r.h);
    if(overlap) return true;
  }
  return false;
}
function tryMove(ent, dx, dy, speed, dt){
  const pw=ent.el.clientWidth, ph=ent.el.clientHeight;
  let nx=ent.el.offsetLeft+dx*speed*dt;
  let ny=ent.el.offsetTop +dy*speed*dt;
  nx=Math.max(0,Math.min(stage.clientWidth -pw,nx));
  ny=Math.max(0,Math.min(stage.clientHeight-ph,ny));
  if(!willCollide(nx,ny,pw,ph)){ ent.el.style.left=nx+'px'; ent.el.style.top=ny+'px'; return true; }
  return false;
}
function moveSmart(ent, dx, dy, speed, dt){
  if(tryMove(ent,dx,dy,speed,dt)) return true;
  if(Math.abs(dx)>=Math.abs(dy)){ if(tryMove(ent,dx,0,speed,dt)) return true; if(tryMove(ent,0,dy,speed,dt)) return true; }
  else{ if(tryMove(ent,0,dy,speed,dt)) return true; if(tryMove(ent,dx,0,speed,dt)) return true; }
  return false;
}

/* ===== Player input ===== */
const keys=new Set();
window.addEventListener('keydown',e=>{const k=e.key.toLowerCase();if(['w','a','s','d','arrowup','arrowleft','arrowdown','arrowright'].includes(k)){keys.add(k);e.preventDefault();}});
window.addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

/* ===== Waypoints waiter ===== */
const WPTS=[{col:16,row:3.5},{col:17,row:3.5},{col:9,row:5.5},{col:4,row:5.5},{col:9,row:8.5},{col:4,row:8.5},{col:17,row:7.5}];
let wptIdx=0, waiterPauseUntil=0;
let pAcc=0, wAcc=0;

/* ======= SISTEM PESANAN & MASAK ======= */

/* Pesanan awal ‚Äî dengan ikon PNG */
let orders=[
  {id:1, name:'Nasi Kari',  cookTime:3500, img:AS.menu.nasi_kari},
  {id:2, name:'Mie Goreng', cookTime:3000, img:AS.menu.mie_goreng},
  {id:3, name:'Steak',      cookTime:5000, img:AS.menu.steak},
  {id:4, name:'Sup Jagung', cookTime:2800, img:AS.menu.sup_jagung},
];

/* Slot dish di meja saji (col 17..20) */
let dishSlot=0;
function placeDishOnCounter(order){
  const tile=T();
  const startCol=17;
  const col = startCol + (dishSlot%4);
  const x=(col-1)*tile, y=(7-1)*tile - tile*0.35; // sedikit di atas meja
  const d=new Image();
  d.src=order.img; d.className='sprite z5';
  d.style.left=x+'px'; d.style.top=y+'px'; d.style.width=tile+'px'; d.style.height=tile+'px';
  d.style.imageRendering='pixelated';
  scene.appendChild(d);
  dishSlot=(dishSlot+1)%4;
}

/* Panel orders (satu untuk semua kompor) */
let ordersUI=null, activeStove=null, cookingMap=new Map(); // map: stoveEl -> {start,dur,bar,wrap,order}

function showOrdersFor(stoveRec){
  activeStove=stoveRec;
  if(!ordersUI){
    ordersUI=document.createElement('div');
    ordersUI.className='orders';
    ordersUI.innerHTML=`<span class="close">‚úñ</span><h4>Pesanan</h4><div class="list"></div><div class="muted" id="emptyMsg" style="display:none">Belum ada pesanan.</div>`;
    stage.appendChild(ordersUI);
    ordersUI.querySelector('.close').onclick=()=>ordersUI.style.display='none';
  }
  // posisikan panel di dekat kompor
  const r = stoveRec.el.getBoundingClientRect();
  const s = stage.getBoundingClientRect();
  ordersUI.style.left = Math.min(s.width-320, Math.max(8, r.left - s.left - 10)) + 'px';
  ordersUI.style.top  = Math.min(s.height-280, Math.max(8, r.top  - s.top  + 50)) + 'px';
  ordersUI.style.display='block';

  const list = ordersUI.querySelector('.list');
  list.innerHTML='';
  if(orders.length===0){
    ordersUI.querySelector('#emptyMsg').style.display='block';
  }else{
    ordersUI.querySelector('#emptyMsg').style.display='none';
    orders.forEach(o=>{
      const btn=document.createElement('button');
      btn.innerHTML=`
        <div class="row">
          <img class="icon" src="${o.img}" alt="">
          <span>${o.name}</span>
        </div>
        <span class="muted">${(o.cookTime/1000).toFixed(1)}s</span>`;
      btn.onclick=()=>startCooking(stoveRec,o);
      list.appendChild(btn);
    });
  }
}

/* Mulai masak di kompor yg dipilih */
function startCooking(stoveRec, order){
  // kalau kompor sedang dipakai, abaikan
  if(cookingMap.has(stoveRec.el)) return;

  // hapus order dari daftar
  orders = orders.filter(o=>o.id!==order.id);
  if(ordersUI) showOrdersFor(stoveRec);

  // progress bar kecil di atas kompor
  const wrap=document.createElement('div'); wrap.className='cookwrap';
  const bar=document.createElement('div');  bar.className='cookbar'; bar.style.transform='scaleX(0)';
  wrap.appendChild(bar);
  stoveRec.el.parentElement.appendChild(wrap);
  // posisikan wrap di atas stove
  const tile=T(); wrap.style.left=stoveRec.el.style.left; wrap.style.top=(stoveRec.el.offsetTop-6)+'px'; wrap.style.width=stoveRec.el.style.width;

  cookingMap.set(stoveRec.el,{start:performance.now(),dur:order.cookTime,bar,wrap,order});
}

/* Klik pada kompor menampilkan panel */
[stove1,stove2].forEach(st=>{
  st.el.addEventListener('click',()=>showOrdersFor(st));
});

/* ====== Main loop ====== */
function loop(t){
  if(!loop.t) loop.t=t; const dt=(t-loop.t)/1000; loop.t=t;
  const tile=T();

  /* Player */
  const spP=tile*6;
  let dx=0,dy=0;
  if(keys.has('a')||keys.has('arrowleft'))  dx-=1;
  if(keys.has('d')||keys.has('arrowright')) dx+=1;
  if(keys.has('w')||keys.has('arrowup'))    dy-=1;
  if(keys.has('s')||keys.has('arrowdown'))  dy+=1;
  if(dx||dy){
    const len=Math.hypot(dx,dy)||1; dx/=len; dy/=len;
    moveSmart(player,dx,dy,spP,dt);
    if(Math.abs(dx)>Math.abs(dy)) player.dir=dx<0?'left':'right'; else player.dir=dy<0?'up':'down';
    pAcc+=dt; if(pAcc>=1/Math.max(1,player.sheet.fps)){pAcc=0; player.frame=(player.frame+1)%player.sheet.frames;}
  }else player.frame=0;
  setFrame(player,player.frame,{down:player.sheet.rowDown,left:player.sheet.rowLeft,right:player.sheet.rowRight,up:player.sheet.rowUp}[player.dir] ?? player.sheet.rowDown);

  /* Waiter auto */
  const spW=tile*3.6;
  if(t>=waiterPauseUntil){
    const target=WPTS[wptIdx];
    const tx=(target.col-0.5)*tile, ty=(target.row-0.5)*tile;
    const cx=waiter.el.offsetLeft+waiter.el.clientWidth/2;
    const cy=waiter.el.offsetTop +waiter.el.clientHeight/2;
    let vx=tx-cx, vy=ty-cy, len=Math.hypot(vx,vy)||1; vx/=len; vy/=len;
    if(Math.abs(vx)>Math.abs(vy)) waiter.dir=vx<0?'left':'right'; else waiter.dir=vy<0?'up':'down';
    moveSmart(waiter,vx,vy,spW,dt);
    wAcc+=dt; if(wAcc>=1/Math.max(1,waiter.sheet.fps)){wAcc=0; waiter.frame=(waiter.frame+1)%waiter.sheet.frames;}
    const dist=Math.hypot(tx-(waiter.el.offsetLeft+waiter.el.clientWidth/2), ty-(waiter.el.offsetTop+waiter.el.clientHeight/2));
    if(dist<tile*0.18){ waiterPauseUntil=t+700; wptIdx=(wptIdx+1)%WPTS.length; }
  }else waiter.frame=0;
  setFrame(waiter,waiter.frame,{down:waiter.sheet.rowDown,left:waiter.sheet.rowLeft,right:waiter.sheet.rowRight,up:waiter.sheet.rowUp}[waiter.dir] ?? waiter.sheet.rowDown);

  /* Update cooking progress */
  if(cookingMap.size){
    for(const [el,info] of Array.from(cookingMap.entries())){
      const prog = Math.min(1,(t-info.start)/info.dur);
      info.bar.style.transform=`scaleX(${prog})`;
      // posisi ulang saat resize/gerak
      info.wrap.style.left = el.style.left;
      info.wrap.style.top  = (el.offsetTop-6)+'px';
      info.wrap.style.width= el.style.width;
      if(prog>=1){
        // selesai
        info.wrap.remove();
        cookingMap.delete(el);
        placeDishOnCounter(info.order);
      }
    }
  }

  requestAnimationFrame(loop);
}

/* Start */
layout();
window.addEventListener('resize',layout);
requestAnimationFrame(loop);

</script>
</body>
</html>
